<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Overtime â€” 3v3 Olympic Hockey</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#111;touch-action:none;user-select:none;-webkit-user-select:none}
canvas{display:block;width:100%;height:100%}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
"use strict";
const C=document.getElementById("c"),X=C.getContext("2d");
let W,H,S; // width, height, scale

function resize(){
  W=C.width=window.innerWidth*devicePixelRatio;
  H=C.height=window.innerHeight*devicePixelRatio;
  S=Math.min(W/1200,H/700);
}
resize();
window.addEventListener("resize",resize);

// â”€â”€â”€ Audio â”€â”€â”€
const AC=new (window.AudioContext||window.webkitAudioContext)();
function unlockAudio(){AC.resume();document.removeEventListener("touchstart",unlockAudio);document.removeEventListener("click",unlockAudio)}
document.addEventListener("touchstart",unlockAudio);
document.addEventListener("click",unlockAudio);

function playSound(freq,dur,type="square",vol=.15){
  const o=AC.createOscillator(),g=AC.createGain();
  o.type=type;o.frequency.value=freq;
  g.gain.setValueAtTime(vol,AC.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+dur);
  o.connect(g);g.connect(AC.destination);
  o.start();o.stop(AC.currentTime+dur);
}
function sndShoot(){playSound(800,.08,"square",.2)}
function sndHit(){playSound(400,.05,"triangle",.15)}
function sndGoal(){
  [0,.1,.2,.3,.4].forEach((t,i)=>{
    setTimeout(()=>playSound(300+i*100,.3,"sawtooth",.25),t*1000);
  });
  // Goal horn
  const o=AC.createOscillator(),g=AC.createGain();
  o.type="sawtooth";o.frequency.value=180;
  g.gain.setValueAtTime(.35,AC.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+2);
  o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+2);
}
function sndWhistle(){playSound(900,.4,"sine",.2);setTimeout(()=>playSound(700,.3,"sine",.15),200)}

// â”€â”€â”€ Constants â”€â”€â”€
const RINK_W=1000,RINK_H=500,GOAL_W=12,GOAL_H=80,GOAL_DEPTH=30;
const PLAYER_R=14,PUCK_R=5;
const FRICTION=.97,PUCK_FRICTION=.985,MAX_SPEED=4.5,AI_SPEED=3.2,SHOOT_POWER=12,PASS_POWER=7;
const PERIOD_TIME=120; // 2 min periods
const CORNER_R=80;

// Team colors
const TEAM1={fill:"#0057B8",stroke:"#FFD700",name:"BLUE"}; // blue/gold
const TEAM2={fill:"#CC0000",stroke:"#FFFFFF",name:"RED"};   // red/white

// â”€â”€â”€ Game State â”€â”€â”€
let state="menu"; // menu, playing, goal, periodEnd, gameOver
let period=1,clock=PERIOD_TIME,score=[0,0];
let players=[],puck,puckOwner=null;
let goalTimer=0,goalScorer=null,periodEndTimer=0;
let joystick={active:false,sx:0,sy:0,cx:0,cy:0,dx:0,dy:0};
let shootBtn={active:false,x:0,y:0,r:0};
let passBtn={active:false,x:0,y:0,r:0};
let keys={};
let particles=[];
let lastTime=0,dt=0;
let faceoffCountdown=0;
let isMobile=('ontouchstart' in window);

class Player{
  constructor(team,x,y,isUser=false){
    this.team=team;this.x=x;this.y=y;this.vx=0;this.vy=0;
    this.isUser=isUser;this.hasPuck=false;this.r=PLAYER_R;
    this.homeX=x;this.homeY=y;this.angle=team===0?0:Math.PI;
    this.stickAngle=0;
  }
}

function createPuck(x,y){return{x:x||RINK_W/2,y:y||RINK_H/2,vx:0,vy:0,r:PUCK_R}}

function initPlayers(){
  players=[];
  // Team 1 (left, blue) â€” player controls center
  players.push(new Player(0,300,RINK_H/2,true));       // user
  players.push(new Player(0,200,RINK_H/2-100));         // AI wing top
  players.push(new Player(0,200,RINK_H/2+100));         // AI wing bot
  // Team 2 (right, red)
  players.push(new Player(1,700,RINK_H/2));
  players.push(new Player(1,800,RINK_H/2-100));
  players.push(new Player(1,800,RINK_H/2+100));
  puck=createPuck();
  puckOwner=null;
}

function faceoff(){
  players[0].x=RINK_W/2-40;players[0].y=RINK_H/2;
  players[1].x=RINK_W/2-120;players[1].y=RINK_H/2-100;
  players[2].x=RINK_W/2-120;players[2].y=RINK_H/2+100;
  players[3].x=RINK_W/2+40;players[3].y=RINK_H/2;
  players[4].x=RINK_W/2+120;players[4].y=RINK_H/2-100;
  players[5].x=RINK_W/2+120;players[5].y=RINK_H/2+100;
  players.forEach(p=>{p.vx=0;p.vy=0;p.hasPuck=false;
    p.homeX=p.x;p.homeY=p.y;});
  puck=createPuck();puckOwner=null;
  faceoffCountdown=90;
}

function startGame(){
  state="playing";period=1;clock=PERIOD_TIME;score=[0,0];
  initPlayers();faceoff();
  sndWhistle();
}

// â”€â”€â”€ Input â”€â”€â”€
document.addEventListener("keydown",e=>{keys[e.key.toLowerCase()]=true;e.preventDefault()});
document.addEventListener("keyup",e=>{keys[e.key.toLowerCase()]=false});

let touches={};
C.addEventListener("touchstart",e=>{
  e.preventDefault();
  for(let t of e.changedTouches){
    const tx=t.clientX*devicePixelRatio,ty=t.clientY*devicePixelRatio;
    touches[t.identifier]={x:tx,y:ty,sx:tx,sy:ty};
    
    if(state==="menu"){startGame();return}
    if(state==="gameOver"){state="menu";return}
    
    // Check shoot button
    const sdx=tx-shootBtn.x,sdy=ty-shootBtn.y;
    if(sdx*sdx+sdy*sdy<shootBtn.r*shootBtn.r){
      shootBtn.active=true;touches[t.identifier].btn="shoot";
      doShoot();continue;
    }
    // Check pass button
    const pdx=tx-passBtn.x,pdy=ty-passBtn.y;
    if(pdx*pdx+pdy*pdy<passBtn.r*passBtn.r){
      passBtn.active=true;touches[t.identifier].btn="pass";
      doPass();continue;
    }
    // Joystick
    if(tx<W/2){
      joystick.active=true;joystick.sx=tx;joystick.sy=ty;
      joystick.cx=tx;joystick.cy=ty;
      touches[t.identifier].btn="joy";
    }
  }
});
C.addEventListener("touchmove",e=>{
  e.preventDefault();
  for(let t of e.changedTouches){
    if(!touches[t.identifier])continue;
    const tx=t.clientX*devicePixelRatio,ty=t.clientY*devicePixelRatio;
    touches[t.identifier].x=tx;touches[t.identifier].y=ty;
    if(touches[t.identifier].btn==="joy"){
      joystick.cx=tx;joystick.cy=ty;
      let dx=tx-joystick.sx,dy=ty-joystick.sy;
      const maxR=60*S;
      const d=Math.sqrt(dx*dx+dy*dy);
      if(d>maxR){dx=dx/d*maxR;dy=dy/d*maxR;}
      joystick.dx=dx/maxR;joystick.dy=dy/maxR;
    }
  }
});
C.addEventListener("touchend",e=>{
  e.preventDefault();
  for(let t of e.changedTouches){
    if(!touches[t.identifier])continue;
    if(touches[t.identifier].btn==="joy"){joystick.active=false;joystick.dx=0;joystick.dy=0;}
    if(touches[t.identifier].btn==="shoot")shootBtn.active=false;
    if(touches[t.identifier].btn==="pass")passBtn.active=false;
    delete touches[t.identifier];
  }
});

C.addEventListener("click",e=>{
  if(state==="menu")startGame();
  if(state==="gameOver")state="menu";
});

function doShoot(){
  const p=players[0];
  if(!p.hasPuck)return;
  sndShoot();
  p.hasPuck=false;puckOwner=null;
  const goalX=RINK_W-GOAL_DEPTH/2,goalY=RINK_H/2;
  const a=Math.atan2(goalY-p.y+(Math.random()-.5)*60,goalX-p.x);
  puck.vx=Math.cos(a)*SHOOT_POWER;
  puck.vy=Math.sin(a)*SHOOT_POWER;
  puck.x=p.x+Math.cos(a)*20;puck.y=p.y+Math.sin(a)*20;
  spawnParticles(puck.x,puck.y,5,"#FFF");
}

function doPass(){
  const p=players[0];
  if(!p.hasPuck)return;
  // Find nearest teammate
  let best=null,bd=Infinity;
  players.forEach(t=>{
    if(t===p||t.team!==p.team)return;
    const d=dist(p,t);if(d<bd){bd=d;best=t;}
  });
  if(!best)return;
  sndHit();
  p.hasPuck=false;puckOwner=null;
  const a=Math.atan2(best.y-p.y,best.x-p.x);
  puck.vx=Math.cos(a)*PASS_POWER;puck.vy=Math.sin(a)*PASS_POWER;
  puck.x=p.x+Math.cos(a)*20;puck.y=p.y+Math.sin(a)*20;
}

// â”€â”€â”€ Helpers â”€â”€â”€
function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y)}
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v))}

function spawnParticles(x,y,n,color){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,sp=Math.random()*3+1;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:30+Math.random()*20,color,r:2+Math.random()*3});
  }
}

// â”€â”€â”€ AI â”€â”€â”€
function updateAI(p,idx){
  if(faceoffCountdown>0)return;
  const isTeam1=p.team===0;
  const goalX=isTeam1?RINK_W-GOAL_DEPTH:GOAL_DEPTH;
  const defGoalX=isTeam1?GOAL_DEPTH:RINK_W-GOAL_DEPTH;
  const goalY=RINK_H/2;
  
  let tx=p.homeX,ty=p.homeY;
  const speed=AI_SPEED;
  
  if(p.hasPuck){
    // Go toward opponent goal and shoot
    tx=goalX;ty=RINK_H/2+(Math.sin(Date.now()/800+idx)*100);
    const dg=dist(p,{x:goalX,y:goalY});
    if(dg<200&&Math.random()<.03){
      // Shoot!
      sndShoot();p.hasPuck=false;puckOwner=null;
      const a=Math.atan2(goalY-p.y+(Math.random()-.5)*50,goalX-p.x);
      puck.vx=Math.cos(a)*SHOOT_POWER;puck.vy=Math.sin(a)*SHOOT_POWER;
      puck.x=p.x+Math.cos(a)*20;puck.y=p.y+Math.sin(a)*20;
      spawnParticles(puck.x,puck.y,5,"#FFF");
      return;
    }
    // Sometimes pass
    if(Math.random()<.005){
      let best=null,bd=Infinity;
      players.forEach(t=>{
        if(t===p||t.team!==p.team)return;
        const d=dist(p,t);if(d<bd&&d>50){bd=d;best=t;}
      });
      if(best){
        sndHit();p.hasPuck=false;puckOwner=null;
        const a=Math.atan2(best.y-p.y,best.x-p.x);
        puck.vx=Math.cos(a)*PASS_POWER;puck.vy=Math.sin(a)*PASS_POWER;
        puck.x=p.x+Math.cos(a)*20;puck.y=p.y+Math.sin(a)*20;
      }
    }
  } else {
    // Chase puck or play position
    const pOwnerTeam=puckOwner?puckOwner.team:-1;
    if(pOwnerTeam===p.team){
      // Teammate has puck â€” get open
      tx=puck.x+(isTeam1?80:-80);
      ty=p.homeY+Math.sin(Date.now()/600+idx*2)*80;
    } else {
      // Chase puck
      const dp=dist(p,puck);
      if(dp<250){tx=puck.x;ty=puck.y;}
      else{
        // Defensive position
        tx=clamp(puck.x+(isTeam1?-100:100),50,RINK_W-50);
        ty=clamp(puck.y+(idx%2===0?-80:80),60,RINK_H-60);
      }
    }
  }
  
  const dx=tx-p.x,dy=ty-p.y;
  const d=Math.hypot(dx,dy);
  if(d>3){
    p.vx+=(dx/d)*speed*.15;
    p.vy+=(dy/d)*speed*.15;
  }
}

// â”€â”€â”€ Physics â”€â”€â”€
function updatePhysics(){
  // Player movement (user)
  const user=players[0];
  if(state==="playing"&&faceoffCountdown<=0){
    let ix=0,iy=0;
    if(joystick.active){ix=joystick.dx;iy=joystick.dy;}
    if(keys["w"]||keys["arrowup"])iy=-1;
    if(keys["s"]||keys["arrowdown"])iy=1;
    if(keys["a"]||keys["arrowleft"])ix=-1;
    if(keys["d"]||keys["arrowright"])ix=1;
    const im=Math.hypot(ix,iy);
    if(im>1){ix/=im;iy/=im;}
    user.vx+=ix*MAX_SPEED*.18;
    user.vy+=iy*MAX_SPEED*.18;
    
    if(keys[" "]){keys[" "]=false;doShoot();}
    if(keys["e"]||keys["shift"]){keys["e"]=false;keys["shift"]=false;doPass();}
  }
  
  // Update all players
  players.forEach((p,i)=>{
    if(!p.isUser)updateAI(p,i);
    p.vx*=FRICTION;p.vy*=FRICTION;
    
    // Speed limit
    const sp=Math.hypot(p.vx,p.vy);
    const maxSp=p.isUser?MAX_SPEED:AI_SPEED;
    if(sp>maxSp){p.vx=p.vx/sp*maxSp;p.vy=p.vy/sp*maxSp;}
    
    p.x+=p.vx;p.y+=p.vy;
    
    // Rink bounds with rounded corners
    constrainToRink(p,p.r);
    
    // Update angle
    if(Math.abs(p.vx)+Math.abs(p.vy)>.3){
      p.angle=Math.atan2(p.vy,p.vx);
    }
    
    // Ice spray particles
    if(sp>2&&Math.random()<.3){
      spawnParticles(p.x,p.y,1,"rgba(200,220,255,0.5)");
    }
  });
  
  // Player-player collisions
  for(let i=0;i<players.length;i++){
    for(let j=i+1;j<players.length;j++){
      const a=players[i],b=players[j];
      const d=dist(a,b);
      if(d<a.r+b.r&&d>0){
        const nx=(b.x-a.x)/d,ny=(b.y-a.y)/d;
        const overlap=(a.r+b.r-d)/2;
        a.x-=nx*overlap;a.y-=ny*overlap;
        b.x+=nx*overlap;b.y+=ny*overlap;
        // Bounce
        const dvx=a.vx-b.vx,dvy=a.vy-b.vy;
        const dot=dvx*nx+dvy*ny;
        if(dot>0){
          a.vx-=dot*nx*.5;a.vy-=dot*ny*.5;
          b.vx+=dot*nx*.5;b.vy+=dot*ny*.5;
          sndHit();
          if(a.hasPuck&&Math.random()<.4){a.hasPuck=false;puckOwner=null;}
          if(b.hasPuck&&Math.random()<.4){b.hasPuck=false;puckOwner=null;}
        }
      }
    }
  }
  
  // Puck
  if(puckOwner){
    puck.x=puckOwner.x+Math.cos(puckOwner.angle)*18;
    puck.y=puckOwner.y+Math.sin(puckOwner.angle)*18;
    puck.vx=puckOwner.vx;puck.vy=puckOwner.vy;
  } else {
    puck.vx*=PUCK_FRICTION;puck.vy*=PUCK_FRICTION;
    puck.x+=puck.vx;puck.y+=puck.vy;
    
    // Puck-wall bounce
    constrainPuckToRink();
    
    // Pickup
    if(faceoffCountdown<=0){
      players.forEach(p=>{
        if(puckOwner)return;
        if(dist(p,puck)<p.r+puck.r+5){
          p.hasPuck=true;puckOwner=p;
          puck.vx=0;puck.vy=0;
          sndHit();
        }
      });
    }
  }
  
  // Goal check
  if(state==="playing"){
    // Left goal (team2 scores)
    if(puck.x<GOAL_DEPTH+GOAL_W&&Math.abs(puck.y-RINK_H/2)<GOAL_H/2){
      scoreGoal(1);
    }
    // Right goal (team1 scores)
    if(puck.x>RINK_W-GOAL_DEPTH-GOAL_W&&Math.abs(puck.y-RINK_H/2)<GOAL_H/2){
      scoreGoal(0);
    }
  }
  
  // Particles
  particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.life--;p.vx*=.95;p.vy*=.95;});
  particles=particles.filter(p=>p.life>0);
}

function constrainToRink(p,r){
  p.x=clamp(p.x,r,RINK_W-r);
  p.y=clamp(p.y,r,RINK_H-r);
  // Corner rounding
  const corners=[[0,0],[RINK_W,0],[0,RINK_H],[RINK_W,RINK_H]];
  corners.forEach(([cx,cy])=>{
    const dx=p.x-cx,dy=p.y-cy;
    if(Math.abs(dx)<CORNER_R&&Math.abs(dy)<CORNER_R){
      const d=Math.hypot(dx,dy);
      if(d<CORNER_R-r)return;
      if(d>0&&d<CORNER_R){
        // outside corner arc check
      }
    }
  });
}

function constrainPuckToRink(){
  // Side walls (but not in goal openings)
  const inGoalRange=Math.abs(puck.y-RINK_H/2)<GOAL_H/2;
  if(puck.x<puck.r&&!(inGoalRange&&puck.x>-GOAL_DEPTH)){
    puck.x=puck.r;puck.vx=Math.abs(puck.vx)*.7;
  }
  if(puck.x>RINK_W-puck.r&&!(inGoalRange&&puck.x<RINK_W+GOAL_DEPTH)){
    puck.x=RINK_W-puck.r;puck.vx=-Math.abs(puck.vx)*.7;
  }
  if(puck.y<puck.r){puck.y=puck.r;puck.vy=Math.abs(puck.vy)*.7;}
  if(puck.y>RINK_H-puck.r){puck.y=RINK_H-puck.r;puck.vy=-Math.abs(puck.vy)*.7;}
}

function scoreGoal(team){
  state="goal";goalTimer=150;
  score[team]++;
  goalScorer=team;
  sndGoal();
  players.forEach(p=>{if(p.hasPuck)p.hasPuck=false;});
  puckOwner=null;
  // Celebration particles
  const gx=team===0?RINK_W-GOAL_DEPTH:GOAL_DEPTH;
  for(let i=0;i<40;i++)spawnParticles(gx,RINK_H/2,3,team===0?"#FFD700":"#FF4444");
}

// â”€â”€â”€ Timer â”€â”€â”€
function updateTimer(){
  if(state!=="playing")return;
  if(faceoffCountdown>0){faceoffCountdown--;return;}
  clock-=1/60;
  if(clock<=0){
    clock=0;
    sndWhistle();
    if(period<3){
      state="periodEnd";periodEndTimer=120;
    } else {
      if(score[0]===score[1]){
        // Overtime!
        period=4;clock=PERIOD_TIME;
        state="periodEnd";periodEndTimer=120;
      } else {
        state="gameOver";
      }
    }
  }
}

// â”€â”€â”€ Draw â”€â”€â”€
function draw(){
  X.clearRect(0,0,W,H);
  X.save();
  // Center and scale rink
  X.translate(W/2-RINK_W/2*S,H/2-RINK_H/2*S);
  X.scale(S,S);
  
  drawRink();
  drawPlayers();
  drawPuck();
  drawParticles();
  
  X.restore();
  
  drawHUD();
  if(isMobile&&state==="playing")drawControls();
  
  if(state==="menu")drawMenu();
  if(state==="goal")drawGoalCelebration();
  if(state==="periodEnd")drawPeriodEnd();
  if(state==="gameOver")drawGameOver();
}

function drawRink(){
  // Ice
  X.fillStyle="#E8F0FE";
  X.beginPath();
  X.moveTo(CORNER_R,0);
  X.lineTo(RINK_W-CORNER_R,0);
  X.arcTo(RINK_W,0,RINK_W,CORNER_R,CORNER_R);
  X.lineTo(RINK_W,RINK_H-CORNER_R);
  X.arcTo(RINK_W,RINK_H,RINK_W-CORNER_R,RINK_H,CORNER_R);
  X.lineTo(CORNER_R,RINK_H);
  X.arcTo(0,RINK_H,0,RINK_H-CORNER_R,CORNER_R);
  X.lineTo(0,CORNER_R);
  X.arcTo(0,0,CORNER_R,0,CORNER_R);
  X.closePath();
  X.fill();
  
  // Rink markings
  X.save();
  X.clip();
  
  // Center line (red)
  X.strokeStyle="#CC0000";X.lineWidth=3;
  X.setLineDash([10,10]);
  X.beginPath();X.moveTo(RINK_W/2,0);X.lineTo(RINK_W/2,RINK_H);X.stroke();
  X.setLineDash([]);
  
  // Center circle
  X.strokeStyle="#0057B8";X.lineWidth=2;
  X.beginPath();X.arc(RINK_W/2,RINK_H/2,60,0,Math.PI*2);X.stroke();
  
  // Center dot
  X.fillStyle="#0057B8";
  X.beginPath();X.arc(RINK_W/2,RINK_H/2,5,0,Math.PI*2);X.fill();
  
  // Blue lines
  X.strokeStyle="#0057B8";X.lineWidth=4;
  X.beginPath();X.moveTo(RINK_W*0.3,0);X.lineTo(RINK_W*0.3,RINK_H);X.stroke();
  X.beginPath();X.moveTo(RINK_W*0.7,0);X.lineTo(RINK_W*0.7,RINK_H);X.stroke();
  
  // Faceoff circles
  const faceoffSpots=[[RINK_W*.2,RINK_H*.3],[RINK_W*.2,RINK_H*.7],
                       [RINK_W*.8,RINK_H*.3],[RINK_W*.8,RINK_H*.7]];
  faceoffSpots.forEach(([fx,fy])=>{
    X.strokeStyle="#CC0000";X.lineWidth=1.5;
    X.beginPath();X.arc(fx,fy,40,0,Math.PI*2);X.stroke();
    X.fillStyle="#CC0000";
    X.beginPath();X.arc(fx,fy,4,0,Math.PI*2);X.fill();
  });
  
  // Goal creases
  X.strokeStyle="#0057B8";X.lineWidth=2;
  X.fillStyle="rgba(150,200,255,0.3)";
  X.beginPath();X.arc(GOAL_DEPTH,RINK_H/2,40,Math.PI*1.5,Math.PI*.5);X.fill();X.stroke();
  X.beginPath();X.arc(RINK_W-GOAL_DEPTH,RINK_H/2,40,Math.PI*.5,Math.PI*1.5);X.fill();X.stroke();
  
  // Goal lines (red)
  X.strokeStyle="#CC0000";X.lineWidth=2;
  X.beginPath();X.moveTo(GOAL_DEPTH,0);X.lineTo(GOAL_DEPTH,RINK_H);X.stroke();
  X.beginPath();X.moveTo(RINK_W-GOAL_DEPTH,0);X.lineTo(RINK_W-GOAL_DEPTH,RINK_H);X.stroke();
  
  X.restore();
  
  // Goals (nets)
  // Left goal
  X.fillStyle="rgba(200,200,200,0.4)";
  X.fillRect(-GOAL_W,RINK_H/2-GOAL_H/2,GOAL_DEPTH+GOAL_W,GOAL_H);
  X.strokeStyle="#CC0000";X.lineWidth=3;
  X.strokeRect(-GOAL_W,RINK_H/2-GOAL_H/2,GOAL_DEPTH+GOAL_W,GOAL_H);
  // Net pattern
  X.strokeStyle="rgba(150,150,150,0.5)";X.lineWidth=.5;
  for(let i=0;i<GOAL_H;i+=8){
    X.beginPath();X.moveTo(-GOAL_W,RINK_H/2-GOAL_H/2+i);
    X.lineTo(GOAL_DEPTH,RINK_H/2-GOAL_H/2+i);X.stroke();
  }
  
  // Right goal
  X.fillStyle="rgba(200,200,200,0.4)";
  X.fillRect(RINK_W-GOAL_DEPTH,RINK_H/2-GOAL_H/2,GOAL_DEPTH+GOAL_W,GOAL_H);
  X.strokeStyle="#CC0000";X.lineWidth=3;
  X.strokeRect(RINK_W-GOAL_DEPTH,RINK_H/2-GOAL_H/2,GOAL_DEPTH+GOAL_W,GOAL_H);
  X.strokeStyle="rgba(150,150,150,0.5)";X.lineWidth=.5;
  for(let i=0;i<GOAL_H;i+=8){
    X.beginPath();X.moveTo(RINK_W-GOAL_DEPTH,RINK_H/2-GOAL_H/2+i);
    X.lineTo(RINK_W+GOAL_W,RINK_H/2-GOAL_H/2+i);X.stroke();
  }
  
  // Boards (thick outline)
  X.strokeStyle="#334";X.lineWidth=5;
  X.beginPath();
  X.moveTo(CORNER_R,0);
  X.lineTo(RINK_W-CORNER_R,0);
  X.arcTo(RINK_W,0,RINK_W,CORNER_R,CORNER_R);
  X.lineTo(RINK_W,RINK_H-CORNER_R);
  X.arcTo(RINK_W,RINK_H,RINK_W-CORNER_R,RINK_H,CORNER_R);
  X.lineTo(CORNER_R,RINK_H);
  X.arcTo(0,RINK_H,0,RINK_H-CORNER_R,CORNER_R);
  X.lineTo(0,CORNER_R);
  X.arcTo(0,0,CORNER_R,0,CORNER_R);
  X.closePath();
  X.stroke();
}

function drawPlayers(){
  players.forEach((p,i)=>{
    const t=p.team===0?TEAM1:TEAM2;
    
    // Shadow
    X.fillStyle="rgba(0,0,0,0.15)";
    X.beginPath();X.ellipse(p.x+2,p.y+3,p.r,p.r*.6,0,0,Math.PI*2);X.fill();
    
    // Body
    X.fillStyle=t.fill;
    X.strokeStyle=t.stroke;X.lineWidth=2.5;
    X.beginPath();X.arc(p.x,p.y,p.r,0,Math.PI*2);X.fill();X.stroke();
    
    // Jersey number
    X.fillStyle="#FFF";X.font="bold 10px Arial";X.textAlign="center";X.textBaseline="middle";
    X.fillText(i<3?(i+1)+"":(i-2)+"",p.x,p.y);
    
    // Stick
    X.strokeStyle="#8B4513";X.lineWidth=2;
    const sa=p.angle+.3;
    X.beginPath();
    X.moveTo(p.x+Math.cos(sa)*p.r,p.y+Math.sin(sa)*p.r);
    X.lineTo(p.x+Math.cos(sa)*(p.r+15),p.y+Math.sin(sa)*(p.r+15));
    X.stroke();
    // Blade
    X.strokeStyle="#333";X.lineWidth=3;
    const bx=p.x+Math.cos(sa)*(p.r+15),by=p.y+Math.sin(sa)*(p.r+15);
    X.beginPath();
    X.moveTo(bx,by);
    X.lineTo(bx+Math.cos(sa+1)*8,by+Math.sin(sa+1)*8);
    X.stroke();
    
    // User indicator
    if(p.isUser){
      X.strokeStyle="#FFD700";X.lineWidth=2;
      X.setLineDash([3,3]);
      X.beginPath();X.arc(p.x,p.y,p.r+5,0,Math.PI*2);X.stroke();
      X.setLineDash([]);
      // Arrow above
      X.fillStyle="#FFD700";
      X.beginPath();
      X.moveTo(p.x,p.y-p.r-12);
      X.lineTo(p.x-5,p.y-p.r-18);
      X.lineTo(p.x+5,p.y-p.r-18);
      X.closePath();X.fill();
    }
    
    // Puck indicator
    if(p.hasPuck){
      X.fillStyle="#FFD700";X.font="bold 8px Arial";
      X.fillText("â—",p.x,p.y-p.r-6);
    }
  });
}

function drawPuck(){
  X.fillStyle="#111";
  X.beginPath();X.arc(puck.x,puck.y,puck.r,0,Math.PI*2);X.fill();
  X.strokeStyle="#333";X.lineWidth=1;X.stroke();
  // Shine
  X.fillStyle="rgba(255,255,255,0.3)";
  X.beginPath();X.arc(puck.x-1,puck.y-1,2,0,Math.PI*2);X.fill();
}

function drawParticles(){
  particles.forEach(p=>{
    X.globalAlpha=p.life/50;
    X.fillStyle=p.color;
    X.beginPath();X.arc(p.x,p.y,p.r*(p.life/50),0,Math.PI*2);X.fill();
  });
  X.globalAlpha=1;
}

function drawHUD(){
  // Scoreboard
  const sbW=260*S,sbH=50*S,sbX=W/2-sbW/2,sbY=8*S;
  X.fillStyle="rgba(0,0,0,0.8)";
  roundRect(sbX,sbY,sbW,sbH,8*S);X.fill();
  
  // Team colors
  X.fillStyle=TEAM1.fill;
  roundRect(sbX+4*S,sbY+4*S,50*S,sbH-8*S,4*S);X.fill();
  X.fillStyle=TEAM2.fill;
  roundRect(sbX+sbW-54*S,sbY+4*S,50*S,sbH-8*S,4*S);X.fill();
  
  // Scores
  X.fillStyle="#FFF";X.font=`bold ${20*S}px Arial`;X.textAlign="center";X.textBaseline="middle";
  X.fillText(score[0],sbX+29*S,sbY+sbH/2);
  X.fillText(score[1],sbX+sbW-29*S,sbY+sbH/2);
  
  // Dash
  X.fillText("â€”",W/2,sbY+sbH/2);
  
  // Timer
  const min=Math.floor(clock/60),sec=Math.floor(clock%60);
  X.font=`${14*S}px Arial`;
  X.fillText(`P${Math.min(period,3)}${period>3?" OT":""} ${min}:${sec.toString().padStart(2,"0")}`,W/2,sbY+sbH+14*S);
}

function drawControls(){
  // Joystick base
  const jx=90*S*devicePixelRatio/devicePixelRatio,jy=H-120*S;
  const jr=55*S;
  shootBtn.x=W-90*S;shootBtn.y=H-120*S;shootBtn.r=40*S;
  passBtn.x=W-90*S;passBtn.y=H-220*S;passBtn.r=30*S;
  
  // Joystick
  X.globalAlpha=.3;
  X.fillStyle="#FFF";
  X.beginPath();X.arc(joystick.active?joystick.sx:jx,joystick.active?joystick.sy:jy,jr,0,Math.PI*2);X.fill();
  X.globalAlpha=.6;
  const knobX=joystick.active?joystick.sx+joystick.dx*jr*.8:jx;
  const knobY=joystick.active?joystick.sy+joystick.dy*jr*.8:jy;
  X.fillStyle="#FFF";
  X.beginPath();X.arc(knobX,knobY,20*S,0,Math.PI*2);X.fill();
  
  // Shoot button
  X.globalAlpha=shootBtn.active?.7:.4;
  X.fillStyle="#CC0000";
  X.beginPath();X.arc(shootBtn.x,shootBtn.y,shootBtn.r,0,Math.PI*2);X.fill();
  X.globalAlpha=1;
  X.fillStyle="#FFF";X.font=`bold ${14*S}px Arial`;X.textAlign="center";X.textBaseline="middle";
  X.fillText("SHOOT",shootBtn.x,shootBtn.y);
  
  // Pass button
  X.globalAlpha=passBtn.active?.7:.4;
  X.fillStyle="#0057B8";
  X.beginPath();X.arc(passBtn.x,passBtn.y,passBtn.r,0,Math.PI*2);X.fill();
  X.globalAlpha=1;
  X.fillStyle="#FFF";X.font=`bold ${11*S}px Arial`;
  X.fillText("PASS",passBtn.x,passBtn.y);
  
  X.globalAlpha=1;
}

function drawMenu(){
  X.fillStyle="rgba(0,0,20,0.85)";
  X.fillRect(0,0,W,H);
  
  // Title
  X.fillStyle="#FFD700";X.font=`bold ${60*S}px Arial`;X.textAlign="center";X.textBaseline="middle";
  X.fillText("OVERTIME",W/2,H*.3);
  
  X.fillStyle="#AAC";X.font=`${18*S}px Arial`;
  X.fillText("3 on 3 Olympic Hockey",W/2,H*.3+40*S);
  
  // Play button
  const bw=180*S,bh=55*S;
  X.fillStyle="#CC0000";
  roundRect(W/2-bw/2,H*.55-bh/2,bw,bh,10*S);X.fill();
  X.fillStyle="#FFF";X.font=`bold ${24*S}px Arial`;
  X.fillText("â–¶  PLAY",W/2,H*.55);
  
  // Controls help
  X.fillStyle="#778";X.font=`${12*S}px Arial`;
  if(isMobile){
    X.fillText("Left stick: Move  |  Buttons: Shoot & Pass",W/2,H*.72);
  } else {
    X.fillText("WASD: Move  |  SPACE: Shoot  |  E: Pass",W/2,H*.72);
  }
  X.fillText("3v3 â€¢ 3 Periods â€¢ 2 Minutes Each",W/2,H*.72+20*S);
}

function drawGoalCelebration(){
  goalTimer--;
  const t=goalScorer;
  const flash=Math.sin(goalTimer*.3)>.0;
  
  if(flash){
    X.fillStyle="rgba(255,0,0,0.08)";
    X.fillRect(0,0,W,H);
  }
  
  X.fillStyle="#FFF";X.font=`bold ${50*S}px Arial`;X.textAlign="center";X.textBaseline="middle";
  X.globalAlpha=Math.min(1,(150-goalTimer)/20);
  X.fillText("ðŸš¨ GOAL! ðŸš¨",W/2,H/2);
  X.font=`${20*S}px Arial`;
  X.fillStyle=t===0?TEAM1.fill:TEAM2.fill;
  X.fillText(`${t===0?TEAM1.name:TEAM2.name} SCORES!`,W/2,H/2+40*S);
  X.globalAlpha=1;
  
  if(goalTimer<=0){
    state="playing";
    faceoff();
  }
}

function drawPeriodEnd(){
  periodEndTimer--;
  X.fillStyle="rgba(0,0,20,0.7)";X.fillRect(0,0,W,H);
  X.fillStyle="#FFF";X.font=`bold ${36*S}px Arial`;X.textAlign="center";X.textBaseline="middle";
  if(period>=3&&score[0]===score[1]){
    X.fillText("OVERTIME!",W/2,H/2);
  } else {
    X.fillText(`END OF PERIOD ${period}`,W/2,H/2);
  }
  X.font=`${20*S}px Arial`;
  X.fillText(`${score[0]} â€” ${score[1]}`,W/2,H/2+35*S);
  
  if(periodEndTimer<=0){
    period++;clock=PERIOD_TIME;state="playing";faceoff();sndWhistle();
  }
}

function drawGameOver(){
  X.fillStyle="rgba(0,0,20,0.85)";X.fillRect(0,0,W,H);
  X.fillStyle="#FFD700";X.font=`bold ${44*S}px Arial`;X.textAlign="center";X.textBaseline="middle";
  X.fillText("GAME OVER",W/2,H*.35);
  X.fillStyle="#FFF";X.font=`bold ${30*S}px Arial`;
  X.fillText(`${score[0]} â€” ${score[1]}`,W/2,H*.5);
  const winner=score[0]>score[1]?TEAM1.name:TEAM2.name;
  X.fillStyle=score[0]>score[1]?TEAM1.fill:TEAM2.fill;
  X.font=`${22*S}px Arial`;
  X.fillText(`${winner} WINS!`,W/2,H*.6);
  X.fillStyle="#778";X.font=`${14*S}px Arial`;
  X.fillText("Tap to play again",W/2,H*.72);
}

function roundRect(x,y,w,h,r){
  X.beginPath();
  X.moveTo(x+r,y);X.lineTo(x+w-r,y);X.arcTo(x+w,y,x+w,y+r,r);
  X.lineTo(x+w,y+h-r);X.arcTo(x+w,y+h,x+w-r,y+h,r);
  X.lineTo(x+r,y+h);X.arcTo(x,y+h,x,y+h-r,r);
  X.lineTo(x,y+r);X.arcTo(x,y,x+r,y,r);
  X.closePath();
}

// â”€â”€â”€ Game Loop â”€â”€â”€
function loop(ts){
  dt=Math.min(ts-(lastTime||ts),33);lastTime=ts;
  
  if(state==="playing"||state==="goal"){
    updatePhysics();
    updateTimer();
  }
  
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
