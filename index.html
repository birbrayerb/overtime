<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>OVERTIME - Hockey</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#111; overflow:hidden; touch-action:none; font-family:'Segoe UI',Arial,sans-serif; }
canvas { display:block; }
#startScreen { position:fixed; inset:0; background:linear-gradient(180deg,#0a1628,#1a3a5c); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; }
#startScreen h1 { font-size:72px; color:#fff; text-shadow:0 0 30px #0af,0 0 60px #06f; letter-spacing:12px; margin-bottom:40px; }
#startScreen button { font-size:28px; padding:16px 60px; background:linear-gradient(180deg,#e22,#b00); color:#fff; border:none; border-radius:12px; cursor:pointer; letter-spacing:4px; }
#startScreen button:hover { background:linear-gradient(180deg,#f44,#d22); }
#hud { position:fixed; top:8px; left:50%; transform:translateX(-50%); z-index:10; display:none; background:rgba(0,0,0,0.7); border-radius:10px; padding:6px 20px; color:#fff; font-size:18px; text-align:center; min-width:260px; }
#hud .score { font-size:32px; font-weight:bold; }
#hud .period { font-size:14px; color:#aaa; }
#controls { position:fixed; bottom:0; left:0; right:0; z-index:10; display:none; pointer-events:none; height:180px; }
#joystickArea { position:absolute; left:20px; bottom:20px; width:140px; height:140px; pointer-events:auto; }
#joystickBase { width:140px; height:140px; background:rgba(255,255,255,0.15); border-radius:50%; border:2px solid rgba(255,255,255,0.3); position:relative; }
#joystickKnob { width:56px; height:56px; background:rgba(255,255,255,0.5); border-radius:50%; position:absolute; top:42px; left:42px; }
#btnArea { position:absolute; right:20px; bottom:20px; pointer-events:auto; display:flex; gap:14px; }
#btnArea button { width:70px; height:70px; border-radius:50%; border:2px solid rgba(255,255,255,0.4); font-size:13px; font-weight:bold; color:#fff; cursor:pointer; }
#btnShoot { background:rgba(220,40,40,0.6); }
#btnPass { background:rgba(40,120,220,0.6); }
#goalOverlay { position:fixed; inset:0; z-index:50; display:none; align-items:center; justify-content:center; pointer-events:none; }
#goalOverlay .goalText { font-size:80px; color:#fff; font-weight:900; text-shadow:0 0 40px red,0 0 80px orange; animation:goalPulse 0.5s ease infinite alternate; }
@keyframes goalPulse { from{transform:scale(1)} to{transform:scale(1.15)} }
</style>
</head>
<body>
<div id="startScreen"><h1>OVERTIME</h1><button onclick="startGame()">â–¶ PLAY</button></div>
<canvas id="c"></canvas>
<div id="hud"><div class="score"><span id="sHome">0</span> - <span id="sAway">0</span></div><div class="period">P<span id="per">1</span> <span id="clock">2:00</span></div></div>
<div id="controls">
  <div id="joystickArea"><div id="joystickBase"><div id="joystickKnob"></div></div></div>
  <div id="btnArea"><button id="btnShoot">SHOOT</button><button id="btnPass">PASS</button></div>
</div>
<div id="goalOverlay"><div class="goalText">ðŸš¨ GOAL! ðŸš¨</div></div>

<script>
const canvas=document.getElementById('c'), ctx=canvas.getContext('2d');
let W,H,rinkX,rinkY,rinkW,rinkH,scale;

function resize(){
  W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight;
  const pad=40, aspect=200/85;
  if((W-pad*2)/(H-pad*2-60)>aspect){ rinkH=H-pad*2-60; rinkW=rinkH*aspect; }
  else { rinkW=W-pad*2; rinkH=rinkW/aspect; }
  rinkX=(W-rinkW)/2; rinkY=(H-rinkH)/2+20;
  scale=rinkW/200;
}
window.addEventListener('resize',resize); resize();

// Game state
const PERIOD_TIME=120, CORNER_R=28;
let gameState='menu', period=1, timeLeft=PERIOD_TIME, scoreHome=0, scoreAway=0;
let goalTimer=0, faceoffTimer=0, particles=[];
let lastTime=0;

// Rink coords (in rink-units, 200x85)
const RW=200, RH=85, CX=100, CY=42.5;

function rx(x){return rinkX+x*scale}
function ry(y){return rinkY+y*scale}
function rs(s){return s*scale}

// Players
const PLAYER_R=3.5, PUCK_R=1.5, GOALIE_R=3;
let players=[], puck={x:CX,y:CY,vx:0,vy:0}, controlledIdx=0;

function createTeam(home){
  const dir=home?1:-1, cx=home?55:145, gx=home?5:195;
  return [
    {x:gx, y:CY, vx:0, vy:0, home, goalie:true, baseX:gx, baseY:CY},
    {x:cx, y:CY, vx:0, vy:0, home, goalie:false, baseX:cx, baseY:CY, role:'center'},
    {x:cx-dir*15, y:CY-18, vx:0, vy:0, home, goalie:false, baseX:cx-dir*15, baseY:CY-18, role:'wing'},
    {x:cx-dir*15, y:CY+18, vx:0, vy:0, home, goalie:false, baseX:cx-dir*15, baseY:CY+18, role:'wing'},
    {x:cx-dir*30, y:CY-14, vx:0, vy:0, home, goalie:false, baseX:cx-dir*30, baseY:CY-14, role:'def'},
    {x:cx-dir*30, y:CY+14, vx:0, vy:0, home, goalie:false, baseX:cx-dir*30, baseY:CY+14, role:'def'},
  ];
}

function resetPositions(){
  const home=createTeam(true), away=createTeam(false);
  players=[...home,...away];
  controlledIdx=1; // center of home team
  puck.x=CX; puck.y=CY; puck.vx=0; puck.vy=0;
  puck.owner=null;
  faceoffTimer=1.5;
}

// Input
let inputDir={x:0,y:0}, shootPressed=false, passPressed=false;
let keys={};
document.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true; if(e.code==='Space'){shootPressed=true;e.preventDefault()} if(e.key.toLowerCase()==='e')passPressed=true;});
document.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;});

// Joystick
let joystickActive=false, joystickId=null;
const jBase=document.getElementById('joystickBase'), jKnob=document.getElementById('joystickKnob');
function handleJoystick(cx,cy,rect){
  const dx=cx-rect.left-70, dy=cy-rect.top-70, dist=Math.sqrt(dx*dx+dy*dy);
  const maxR=50, clamp=Math.min(dist,maxR);
  const nx=dist>0?dx/dist:0, ny=dist>0?dy/dist:0;
  jKnob.style.left=(42+nx*clamp)+'px'; jKnob.style.top=(42+ny*clamp)+'px';
  inputDir.x=nx*(clamp/maxR); inputDir.y=ny*(clamp/maxR);
}
jBase.addEventListener('touchstart',e=>{e.preventDefault();joystickActive=true;joystickId=e.changedTouches[0].identifier;handleJoystick(e.changedTouches[0].clientX,e.changedTouches[0].clientY,jBase.getBoundingClientRect());},{passive:false});
jBase.addEventListener('touchmove',e=>{e.preventDefault();for(let t of e.changedTouches)if(t.identifier===joystickId)handleJoystick(t.clientX,t.clientY,jBase.getBoundingClientRect());},{passive:false});
function resetJoystick(){joystickActive=false;joystickId=null;jKnob.style.left='42px';jKnob.style.top='42px';inputDir.x=0;inputDir.y=0;}
jBase.addEventListener('touchend',e=>{for(let t of e.changedTouches)if(t.identifier===joystickId)resetJoystick();});
jBase.addEventListener('touchcancel',resetJoystick);

document.getElementById('btnShoot').addEventListener('touchstart',e=>{e.preventDefault();shootPressed=true;},{passive:false});
document.getElementById('btnPass').addEventListener('touchstart',e=>{e.preventDefault();passPressed=true;},{passive:false});

// Audio
const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
function playHorn(){
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sawtooth';o.frequency.value=220;g.gain.setValueAtTime(0.3,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+1.5);
  o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+1.5);
}
function playWhistle(){
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sine';o.frequency.value=800;g.gain.setValueAtTime(0.15,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.4);
  o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.4);
}

// Particles
function spawnGoalParticles(x,y){
  for(let i=0;i<40;i++){
    const a=Math.random()*Math.PI*2, sp=Math.random()*60+20;
    particles.push({x:rx(x),y:ry(y),vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1.5,
      color:['#f44','#ff0','#fff','#f80'][Math.floor(Math.random()*4)]});
  }
}

function startGame(){
  document.getElementById('startScreen').style.display='none';
  document.getElementById('hud').style.display='block';
  document.getElementById('controls').style.display='block';
  scoreHome=0; scoreAway=0; period=1; timeLeft=PERIOD_TIME;
  resetPositions();
  gameState='playing';
  audioCtx.resume();
}

function goalScored(byHome){
  if(byHome)scoreHome++; else scoreAway++;
  document.getElementById('sHome').textContent=scoreHome;
  document.getElementById('sAway').textContent=scoreAway;
  playHorn();
  spawnGoalParticles(puck.x,puck.y);
  const ov=document.getElementById('goalOverlay');ov.style.display='flex';
  goalTimer=2.5;
  gameState='goal';
}

function endPeriod(){
  playWhistle();
  if(period<3||(period===3&&scoreHome===scoreAway)){
    if(period<3)period++; else period=4; // OT
    timeLeft=PERIOD_TIME;
    resetPositions();
    document.getElementById('per').textContent=period===4?'OT':period;
    faceoffTimer=2;
  } else {
    gameState='gameover';
  }
}

// Distance
function dist(a,b){return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2)}

// Clamp to rink with rounded corners
function clampToRink(obj,r){
  const pr=r||0;
  obj.x=Math.max(pr+1,Math.min(RW-pr-1,obj.x));
  obj.y=Math.max(pr+1,Math.min(RH-pr-1,obj.y));
  // rounded corners
  const cr=CORNER_R;
  const corners=[[cr,cr],[RW-cr,cr],[cr,RH-cr],[RW-cr,RH-cr]];
  for(const [cx,cy] of corners){
    const dx=obj.x-cx, dy=obj.y-cy;
    const inCorner=(obj.x<cr&&obj.y<cr)||(obj.x>RW-cr&&obj.y<cr)||(obj.x<cr&&obj.y>RH-cr)||(obj.x>RW-cr&&obj.y>RH-cr);
    if(inCorner){
      const d=Math.sqrt(dx*dx+dy*dy);
      if(d>cr-pr){
        const nx=dx/d,ny=dy/d;
        obj.x=cx+nx*(cr-pr); obj.y=cy+ny*(cr-pr);
      }
    }
  }
}

function puckInGoal(){
  // Goals at x=0 and x=200, y between ~37 and ~48 (net width ~11)
  const netHalf=5.5;
  if(puck.x<=1.5 && Math.abs(puck.y-CY)<netHalf) return 'away'; // away scores (shooting left)
  if(puck.x>=RW-1.5 && Math.abs(puck.y-CY)<netHalf) return 'home'; // home scores
  return null;
}

// AI
function aiUpdate(idx,dt){
  const p=players[idx]; if(!p)return;
  const isHome=p.home;
  const attackDir=isHome?1:-1;
  const hasPuck=puck.owner===idx;
  const teamHasPuck=puck.owner!==null&&players[puck.owner].home===isHome;
  
  let tx=p.baseX, ty=p.baseY, speed=38;
  
  if(p.goalie){
    // Goalie AI: track puck y, stay near goal
    const gx=p.baseX;
    const targetY=CY+(puck.y-CY)*0.6;
    tx=gx+(puck.x-gx)*0.08;
    ty=Math.max(CY-8,Math.min(CY+8,targetY));
    tx=isHome?Math.max(2,Math.min(12,tx)):Math.max(RW-12,Math.min(RW-2,tx));
    speed=30;
    // If puck very close, try to block
    if(dist(p,puck)<8&&puck.owner===null){
      puck.vx*=-0.5; puck.vy*=0.3;
      puck.owner=idx;
    }
  } else if(hasPuck){
    // Skate toward opponent goal and shoot
    tx=isHome?RW-20:20; ty=CY+(p.y>CY?-10:10);
    speed=42;
    const goalX=isHome?RW:0;
    if(Math.abs(p.x-goalX)<45){
      // Shoot!
      const ang=Math.atan2(CY-p.y,goalX-p.x)+(Math.random()-0.5)*0.3;
      puck.vx=Math.cos(ang)*90; puck.vy=Math.sin(ang)*90;
      puck.owner=null;
    }
  } else if(teamHasPuck){
    // Support: move toward attacking zone
    tx=p.baseX+attackDir*15; ty=p.baseY;
    speed=35;
  } else {
    // Chase puck if close, else go to base
    if(dist(p,puck)<30&&puck.owner===null){
      tx=puck.x; ty=puck.y; speed=40;
      if(dist(p,puck)<PLAYER_R+PUCK_R+1&&puck.owner===null){
        puck.owner=idx;
      }
    } else if(puck.owner!==null&&!players[puck.owner].home===isHome){
      // Defend: move toward puck carrier
      const carrier=players[puck.owner];
      tx=carrier.x-attackDir*5; ty=carrier.y;
      speed=36;
      // Check/steal
      if(dist(p,carrier)<PLAYER_R*2+1){
        if(Math.random()<0.03){
          puck.owner=null;
          puck.vx=(Math.random()-0.5)*20; puck.vy=(Math.random()-0.5)*20;
        }
      }
    }
  }
  
  const dx=tx-p.x, dy=ty-p.y, d=Math.sqrt(dx*dx+dy*dy);
  if(d>0.5){
    p.vx+=(dx/d)*speed*dt*3; p.vy+=(dy/d)*speed*dt*3;
  }
}

function update(dt){
  if(gameState!=='playing') return;
  if(faceoffTimer>0){faceoffTimer-=dt;return;}
  
  // Time
  timeLeft-=dt;
  if(timeLeft<=0){timeLeft=0; endPeriod(); return;}
  const mins=Math.floor(timeLeft/60), secs=Math.floor(timeLeft%60);
  document.getElementById('clock').textContent=mins+':'+(secs<10?'0':'')+secs;
  
  // Keyboard input
  if(!joystickActive){
    inputDir.x=0; inputDir.y=0;
    if(keys['a']||keys['arrowleft'])inputDir.x=-1;
    if(keys['d']||keys['arrowright'])inputDir.x=1;
    if(keys['w']||keys['arrowup'])inputDir.y=-1;
    if(keys['s']||keys['arrowdown'])inputDir.y=1;
    const m=Math.sqrt(inputDir.x**2+inputDir.y**2);
    if(m>1){inputDir.x/=m;inputDir.y/=m;}
  }
  
  // Controlled player movement
  const cp=players[controlledIdx];
  const SPEED=50;
  cp.vx+=inputDir.x*SPEED*dt*3;
  cp.vy+=inputDir.y*SPEED*dt*3;
  
  // Pick up puck
  if(puck.owner===null && dist(cp,puck)<PLAYER_R+PUCK_R+1.5){
    puck.owner=controlledIdx;
  }
  
  // Shoot
  if(shootPressed){
    shootPressed=false;
    if(puck.owner===controlledIdx){
      const ang=Math.atan2(CY-cp.y, RW-cp.x);
      puck.vx=Math.cos(ang)*100; puck.vy=Math.sin(ang)*100;
      puck.owner=null;
    }
  }
  
  // Pass
  if(passPressed){
    passPressed=false;
    if(puck.owner===controlledIdx){
      // Find nearest teammate
      let best=null, bestD=999;
      for(let i=0;i<players.length;i++){
        if(i!==controlledIdx && players[i].home===cp.home && !players[i].goalie){
          const d=dist(cp,players[i]);
          if(d<bestD){bestD=d;best=i;}
        }
      }
      if(best!==null){
        const t=players[best];
        const ang=Math.atan2(t.y-cp.y,t.x-cp.x);
        puck.vx=Math.cos(ang)*65; puck.vy=Math.sin(ang)*65;
        puck.owner=null;
      }
    }
  }
  
  // AI
  for(let i=0;i<players.length;i++){
    if(i===controlledIdx)continue;
    aiUpdate(i,dt);
  }
  
  // Physics for all players
  const FRICTION=0.92;
  for(const p of players){
    p.x+=p.vx*dt; p.y+=p.vy*dt;
    p.vx*=FRICTION; p.vy*=FRICTION;
    clampToRink(p, PLAYER_R);
  }
  
  // Puck physics
  if(puck.owner!==null){
    const o=players[puck.owner];
    const ahead=o.goalie?0:3;
    const ang=Math.atan2(o.vy,o.vx);
    puck.x=o.x+(Math.abs(o.vx)>0.5?Math.cos(ang)*ahead:0);
    puck.y=o.y+(Math.abs(o.vy)>0.5?Math.sin(ang)*ahead:0);
    puck.vx=0; puck.vy=0;
  } else {
    puck.x+=puck.vx*dt; puck.y+=puck.vy*dt;
    puck.vx*=0.985; puck.vy*=0.985;
    // Bounce off top/bottom
    if(puck.y<PUCK_R){puck.y=PUCK_R;puck.vy*=-0.7;}
    if(puck.y>RH-PUCK_R){puck.y=RH-PUCK_R;puck.vy*=-0.7;}
    // Bounce off left/right (but not in goal)
    if(puck.x<PUCK_R&&(puck.y<CY-5.5||puck.y>CY+5.5)){puck.x=PUCK_R;puck.vx*=-0.7;}
    if(puck.x>RW-PUCK_R&&(puck.y<CY-5.5||puck.y>CY+5.5)){puck.x=RW-PUCK_R;puck.vx*=-0.7;}
    clampToRink(puck,PUCK_R);
    
    // AI pickup
    for(let i=0;i<players.length;i++){
      if(i===controlledIdx)continue;
      if(dist(players[i],puck)<PLAYER_R+PUCK_R+1){
        puck.owner=i; break;
      }
    }
  }
  
  // Goal check
  const g=puckInGoal();
  if(g){
    goalScored(g==='home');
  }
  
  // Switch controlled player to nearest to puck when team doesn't have it
  if(puck.owner===null || !players[puck.owner].home){
    let best=null, bestD=999;
    for(let i=0;i<6;i++){
      if(players[i].goalie)continue;
      const d=dist(players[i],puck);
      if(d<bestD){bestD=d;best=i;}
    }
    if(best!==null && best!==controlledIdx && bestD<dist(players[controlledIdx],puck)-5){
      controlledIdx=best;
    }
  }
  
  // Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=80*dt; p.life-=dt;
    if(p.life<=0)particles.splice(i,1);
  }
}

function drawRink(){
  // Boards background
  ctx.fillStyle='#1a2a3a';
  const bx=rinkX-4, by=rinkY-4, bw=rinkW+8, bh=rinkH+8, br=rs(CORNER_R)+4;
  ctx.beginPath();
  ctx.moveTo(bx+br,by); ctx.lineTo(bx+bw-br,by); ctx.arcTo(bx+bw,by,bx+bw,by+br,br);
  ctx.lineTo(bx+bw,by+bh-br); ctx.arcTo(bx+bw,by+bh,bx+bw-br,by+bh,br);
  ctx.lineTo(bx+br,by+bh); ctx.arcTo(bx,by+bh,bx,by+bh-br,br);
  ctx.lineTo(bx,by+br); ctx.arcTo(bx,by,bx+br,by,br);
  ctx.fill();
  
  // Ice
  ctx.fillStyle='#e8f0f8';
  const cr=rs(CORNER_R);
  ctx.beginPath();
  ctx.moveTo(rinkX+cr,rinkY); ctx.lineTo(rinkX+rinkW-cr,rinkY); ctx.arcTo(rinkX+rinkW,rinkY,rinkX+rinkW,rinkY+cr,cr);
  ctx.lineTo(rinkX+rinkW,rinkY+rinkH-cr); ctx.arcTo(rinkX+rinkW,rinkY+rinkH,rinkX+rinkW-cr,rinkY+rinkH,cr);
  ctx.lineTo(rinkX+cr,rinkY+rinkH); ctx.arcTo(rinkX,rinkY+rinkH,rinkX,rinkY+rinkH-cr,cr);
  ctx.lineTo(rinkX,rinkY+cr); ctx.arcTo(rinkX,rinkY,rinkX+cr,rinkY,cr);
  ctx.fill();
  
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(rinkX+cr,rinkY); ctx.lineTo(rinkX+rinkW-cr,rinkY); ctx.arcTo(rinkX+rinkW,rinkY,rinkX+rinkW,rinkY+cr,cr);
  ctx.lineTo(rinkX+rinkW,rinkY+rinkH-cr); ctx.arcTo(rinkX+rinkW,rinkY+rinkH,rinkX+rinkW-cr,rinkY+rinkH,cr);
  ctx.lineTo(rinkX+cr,rinkY+rinkH); ctx.arcTo(rinkX,rinkY+rinkH,rinkX,rinkY+rinkH-cr,cr);
  ctx.lineTo(rinkX,rinkY+cr); ctx.arcTo(rinkX,rinkY,rinkX+cr,rinkY,cr);
  ctx.clip();
  
  // Red center line
  ctx.strokeStyle='#cc0000'; ctx.lineWidth=rs(0.8);
  ctx.beginPath(); ctx.moveTo(rx(CX),rinkY); ctx.lineTo(rx(CX),rinkY+rinkH); ctx.stroke();
  
  // Blue lines
  ctx.strokeStyle='#0044aa'; ctx.lineWidth=rs(1.2);
  ctx.beginPath(); ctx.moveTo(rx(75),rinkY); ctx.lineTo(rx(75),rinkY+rinkH); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(rx(125),rinkY); ctx.lineTo(rx(125),rinkY+rinkH); ctx.stroke();
  
  // Red goal lines
  ctx.strokeStyle='#cc0000'; ctx.lineWidth=rs(0.5);
  ctx.beginPath(); ctx.moveTo(rx(11),rinkY); ctx.lineTo(rx(11),rinkY+rinkH); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(rx(189),rinkY); ctx.lineTo(rx(189),rinkY+rinkH); ctx.stroke();
  
  // Center circle
  ctx.strokeStyle='#cc0000'; ctx.lineWidth=rs(0.5);
  ctx.beginPath(); ctx.arc(rx(CX),ry(CY),rs(15),0,Math.PI*2); ctx.stroke();
  // Center dot
  ctx.fillStyle='#cc0000';
  ctx.beginPath(); ctx.arc(rx(CX),ry(CY),rs(1),0,Math.PI*2); ctx.fill();
  
  // End zone faceoff circles and dots
  const faceoffSpots=[
    [20,CY-22],[20,CY+22],[180,CY-22],[180,CY+22], // end zone (with circles)
    [80,CY-22],[80,CY+22],[120,CY-22],[120,CY+22], // neutral zone (dots only)
  ];
  for(let i=0;i<4;i++){
    const [fx,fy]=faceoffSpots[i];
    ctx.strokeStyle='#cc0000'; ctx.lineWidth=rs(0.5);
    ctx.beginPath(); ctx.arc(rx(fx),ry(fy),rs(15),0,Math.PI*2); ctx.stroke();
    ctx.fillStyle='#cc0000';
    ctx.beginPath(); ctx.arc(rx(fx),ry(fy),rs(1),0,Math.PI*2); ctx.fill();
  }
  for(let i=4;i<8;i++){
    const [fx,fy]=faceoffSpots[i];
    ctx.fillStyle='#cc0000';
    ctx.beginPath(); ctx.arc(rx(fx),ry(fy),rs(1),0,Math.PI*2); ctx.fill();
  }
  
  // Goal creases (blue)
  ctx.fillStyle='rgba(60,120,220,0.3)'; ctx.strokeStyle='#cc0000'; ctx.lineWidth=rs(0.4);
  // Left crease
  ctx.beginPath(); ctx.arc(rx(11),ry(CY),rs(6),Math.PI*1.5,Math.PI*0.5); ctx.lineTo(rx(11),ry(CY+6)); ctx.closePath(); ctx.fill(); ctx.stroke();
  // Right crease
  ctx.beginPath(); ctx.arc(rx(189),ry(CY),rs(6),Math.PI*0.5,Math.PI*1.5); ctx.lineTo(rx(189),ry(CY-6)); ctx.closePath(); ctx.fill(); ctx.stroke();
  
  // Nets
  ctx.fillStyle='rgba(200,200,200,0.5)'; ctx.strokeStyle='#888'; ctx.lineWidth=2;
  ctx.fillRect(rx(-3),ry(CY-5.5),rs(4),rs(11)); ctx.strokeRect(rx(-3),ry(CY-5.5),rs(4),rs(11));
  ctx.fillRect(rx(199),ry(CY-5.5),rs(4),rs(11)); ctx.strokeRect(rx(199),ry(CY-5.5),rs(4),rs(11));
  
  ctx.restore();
}

function drawPlayer(p,idx){
  const isControlled=idx===controlledIdx;
  const color=p.home?(p.goalie?'#2266cc':'#2288ff'):(p.goalie?'#cc2222':'#ee3333');
  const r=rs(p.goalie?GOALIE_R:PLAYER_R);
  
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.15)';
  ctx.beginPath(); ctx.ellipse(rx(p.x)+1,ry(p.y)+2,r,r*0.6,0,0,Math.PI*2); ctx.fill();
  
  // Body
  ctx.fillStyle=color;
  ctx.beginPath(); ctx.arc(rx(p.x),ry(p.y),r,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,0.4)'; ctx.lineWidth=1.5;
  ctx.stroke();
  
  // Controlled indicator
  if(isControlled){
    ctx.strokeStyle='#ffdd00'; ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.arc(rx(p.x),ry(p.y),r+3,0,Math.PI*2); ctx.stroke();
    // Arrow showing direction if moving
    if(Math.abs(inputDir.x)>0.1||Math.abs(inputDir.y)>0.1){
      const ang=Math.atan2(inputDir.y,inputDir.x);
      ctx.strokeStyle='#ffdd00'; ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(rx(p.x)+Math.cos(ang)*(r+4),ry(p.y)+Math.sin(ang)*(r+4));
      ctx.lineTo(rx(p.x)+Math.cos(ang)*(r+10),ry(p.y)+Math.sin(ang)*(r+10));
      ctx.stroke();
    }
  }
  
  // Jersey number
  ctx.fillStyle='#fff'; ctx.font=`bold ${Math.max(10,r*0.9|0)}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
  const num=p.goalie?'G':(idx%6+1);
  ctx.fillText(num,rx(p.x),ry(p.y)+1);
}

function drawPuck(){
  const r=rs(PUCK_R);
  ctx.fillStyle='#111';
  ctx.beginPath(); ctx.arc(rx(puck.x),ry(puck.y),r,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#333'; ctx.lineWidth=1;
  ctx.stroke();
}

function drawParticles(){
  for(const p of particles){
    ctx.globalAlpha=p.life;
    ctx.fillStyle=p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha=1;
}

function draw(){
  ctx.fillStyle='#0a0a0a'; ctx.fillRect(0,0,W,H);
  drawRink();
  // Draw players (away first, then home on top)
  for(let i=6;i<12;i++) drawPlayer(players[i],i);
  drawPuck();
  for(let i=0;i<6;i++) drawPlayer(players[i],i);
  drawParticles();
  
  if(gameState==='gameover'){
    ctx.fillStyle='rgba(0,0,0,0.7)'; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#fff'; ctx.font='bold 48px Arial'; ctx.textAlign='center';
    ctx.fillText('GAME OVER',W/2,H/2-30);
    ctx.font='32px Arial';
    ctx.fillText(scoreHome>scoreAway?'HOME WINS!':'AWAY WINS!',W/2,H/2+20);
    ctx.font='20px Arial'; ctx.fillStyle='#aaa';
    ctx.fillText('Tap or press any key to restart',W/2,H/2+60);
  }
}

function gameLoop(ts){
  const dt=Math.min((ts-(lastTime||ts))/1000, 0.05);
  lastTime=ts;
  
  if(gameState==='goal'){
    goalTimer-=dt;
    // Still update particles
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i]; p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=80*dt; p.life-=dt;
      if(p.life<=0)particles.splice(i,1);
    }
    if(goalTimer<=0){
      document.getElementById('goalOverlay').style.display='none';
      gameState='playing';
      resetPositions();
    }
  }
  
  update(dt);
  resize();
  draw();
  requestAnimationFrame(gameLoop);
}

// Restart on gameover
document.addEventListener('click',()=>{if(gameState==='gameover')startGame();});
document.addEventListener('keydown',()=>{if(gameState==='gameover')startGame();});

requestAnimationFrame(gameLoop);
</script>
</body>
</html>
